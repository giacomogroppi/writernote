name: writernote
version: 0.1.6

summary: Writernote

description: |
  writernote is a multiplatform application that allows you to take notes by recording audio, 
  translate it later into text, and listen to it in an intelligent way.

grade: devel
#confinement: devmode
confinement: strict
base: core20



apps:
  writernote:
    command-chain: ["snap/command-chain/alsa-launch"]
    command: bin/desktop-launch $SNAP/bin/writernote

    # enviroment for core20
    environment:
    #  #LD_LIBRARY_PATH: $SNAP/lib/python3.8/site-packages
      PYTHONPATH: $SNAP/lib/python3.8/site-packages:$SNAP/usr/lib/python3/dist-packages
      #PYTHONPATH: $SNAP/usr/lib/python3/dist-packages

    plugs:
      - alsa
      - desktop
      - desktop-legacy
      - wayland
      - x11
      - opengl
      - audio-record
      - home
      - pulseaudio
      - unity7
      - browser-support
      - network
      - gsettings
      - network-bind
      - audio-playback
      - network-manager
      - process-control
      - mount-observe

      - optical-drive
      - camera
      - removable-media
      - screen-inhibit-control
      - dvb
      #- jack1
      - avahi-control

    slots:
      - mpris


layout:
  /usr/lib/$SNAPCRAFT_ARCH_TRIPLET/alsa-lib:
    bind: $SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/alsa-lib

  /usr/share/X11:
    bind: $SNAP/usr/share/X11

plugs:
  gsettings:
  gtk-3-themes:
    interface: content
    target: $SNAP/data-dir/themes
    default-provider: gtk-common-themes
  icon-themes:
    interface: content
    target: $SNAP/data-dir/icons
    default-provider: gtk-common-themes
  sound-themes:
    interface: content
    target: $SNAP/data-dir/sounds
    default-provider: gtk-common-themes
  qt551:
    interface: content
    target: $SNAP/qt551
    default-provider: qt551



parts:
  alsa-mixin:
    plugin: dump
    source: https://github.com/diddlesnaps/snapcraft-alsa.git
    source-subdir: snapcraft-assets
    build-packages:
      - libasound2-dev
    stage-packages:
      - libasound2
      - libasound2-plugins


  desktop-qt5:
    source: https://github.com/ubuntu/snapcraft-desktop-helpers.git
    source-subdir: qt
    plugin: make
    make-parameters: ["FLAVOR=qt5"]
    build-packages:
      - build-essential
      - qtbase5-dev
      - dpkg-dev
    stage-packages:
      - libxkbcommon0
      - ttf-ubuntu-font-family
      - dmz-cursor-theme
      - light-themes
      - adwaita-icon-theme
      - gnome-themes-standard
      - shared-mime-info
      - libqt5gui5
      - libgdk-pixbuf2.0-0
      - libqt5svg5 # for loading icon themes which are svg
      - try: [appmenu-qt5] # not available on core18
      - locales-all
      - xdg-user-dirs
      - fcitx-frontend-qt5


  writernote:
    after: [desktop-qt5, alsa-mixin]
    plugin: python
    #python-version: python3
    source: .

    # setting enviroment for python3 for the gcc [Python.h]
    build-environment:
      - C_INCLUDE_PATH: /usr/include/python3.8/

    build-packages:
      - build-essential
      - python3
      - python3.8-dev
      - python3-dev
      - python3-pyqt5
      - libpython3-dev
      - python3-setuptools
      - execstack
      - libasound2-dev
      - gcc
      - libopus-dev
      - python3-pip
      - python3-wheel
      - python3-venv
      - python3-minimal
      - python3-pkg-resources
      - python3.8-minimal
      - libpython3-stdlib
      - libpython3.8-stdlib
    
      #  - libortp9

    # correct problem with core20
    #override-build: |
    #  echo INSTALL PYTHON PACKAGE
    #  python3 -m pip install pydub 
    #  python3 -m pip install psutil 
    #  python3 -m pip install googletrans 
    #  python3 -m pip install nvpy
    #  python3 -m pip install Wave 
    #  python3 -m pip install pytesseract 
    #  python3 -m pip install SpeechRecognition
    #  echo INSTALLING FINISHED

    stage-packages:
      # implementation for core20
      - libpython3-stdlib
      - libpython3.8-stdlib
      - libpython3.8-minimal
      - libgfortran-10-dev # for shared library in numpy
      - python3-pip
      - python3-wheel
      - python3-setuptools
      - python3-venv
      - python3-minimal
      - python3-pkg-resources
      - python3.8-minimal
      #- python3-numpy

      - python3
      - libc-bin
      - locales
      - libasound2
      - python3-pyqt5
      - ffmpeg
      - python3-tk
      - python3-pyaudio
      #- python-pyaudio # not available on core20, in core 18 yes
      - qt5-gtk-platformtheme
      - python3-pyqt5.qtwebengine
      - python3-apt
      - python3-pyqt5.qtmultimedia
      - python3-distutils     
      
      #- try: python3-nanomsg #not available on core20, in core 18 yes
      - libmpfr6
      - libgmp10
      - libqt5multimedia5-plugins
      - libcanberra-gtk-module 
      - libcanberra-gtk3-module
      - libasound-dev
      - libasound2-plugins
      # audio
      #- libasound0
      #- libortop9
    
    python-packages:
      - setuptools #>=45.2.0
      - wheel
      - pydub
      - SpeechRecognition
      - psutil #>=5.7.2
      - googletrans
      - nvpy
      #- numpy
      #- PyQt5
      #- multiprocessing==2.6.2.1
      - Wave
      #- opencv-python
      - pytesseract
      
  
  qt5-xdgdesktopportal-platform:
    plugin: nil
    stage-packages:
      - qt5-xdgdesktopportal-platformtheme

  # Qt checks that ibus-daemon binary is present, otherwise doesn't work
  ibus:
    plugin: nil
    stage-packages:
      - ibus

  ffmpeg:
    plugin: nil
    build-packages:
      - libavcodec-dev
      - libavformat-dev
      - libavutil-dev
      - libswresample-dev
      - libswscale-dev
    stage-packages:
      - libavcodec58
      - libavformat58
      - libavutil56
      - libswresample3
      - libswscale5


  qtwayland:
    source: https://github.com/qt/qtwayland.git
    source-depth: 1
    source-tag: v5.12.8
    plugin: dump
    
    override-build: |
      echo START COMPILE QTWAYLAND WITH
      nproc

      qmake
      make -j$(nproc)
      make INSTALL_ROOT="$SNAPCRAFT_PART_INSTALL" install
    stage: [-./usr/lib]
    prime: [-./*]
    after:
      - desktop-qt5

  webrtc:
    source: https://github.com/desktop-app/tg_owt.git
    source-depth: 1
    plugin: cmake
    build-packages:
      - yasm
      - libjpeg8-dev
      - pkg-config
      - apt-utils
      - libpulse-dev
      - libopus-dev
      - libssl-dev
    stage-packages:
      - libjpeg8
      - libopus0
      - libssl1.1
      
    override-build: |
      echo START COMPILE webrtc WITH
      nproc

      cmake "$SNAPCRAFT_PART_SRC" -DCMAKE_BUILD_TYPE=Release
      cmake --build . -- -j$(nproc)
      cp -a . "$SNAPCRAFT_PART_INSTALL"
    organize:
      "*": tg_owt/
    prime: [-./*]
